<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Work Request</title>
     <link rel="stylesheet" href="styles.css">
    <style>
        
    </style>
</head>
<body>
    <header>
        <h1>Daftar Work Request</h1>
    </header>
    <div class="container">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Nomor</th>
                        <th>Jam</th>
                        <th>Tag Number</th>
                        <th>Indication</th>
                        <th>MTC by</th>
                        <th>Status</th>
                        <th>WR</th>
                        <th>PIC</th>
                        <th>WR Number</th>
                        <th>Update</th>
                        <th>Riwayat Update</th>
                        <th>Hapus</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Table rows -->
                </tbody>
            </table>
        </div>
        <div class="button-container">
            <button onclick="window.location.href='index.html'">Kembali ke Input Work Request</button>
        </div>
    </div>
    <footer>
        Create by M. Ardiantsyah
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD21AniBt0GcuShvdrmeJR3lmdOlYhUEiU",
            authDomain: "workrequest-8482a.firebaseapp.com",
            databaseURL: "https://workrequest-8482a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "workrequest-8482a",
            storageBucket: "workrequest-8482a.appspot.com",
            messagingSenderId: "230020602695",
            appId: "1:230020602695:web:802e9f107a8987e532ca62"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Fetch data from Firebase and display in the table
        const workRequestRef = ref(database, 'workRequests');
        onValue(workRequestRef, (snapshot) => {
            const data = snapshot.val();
            const tableBody = document.querySelector('.table-container table tbody');
            tableBody.innerHTML = '';
            let count = 1;
            for (let id in data) {
                const row = document.createElement('tr');
                const lastUpdate = data[id].updateHistory ? data[id].updateHistory[data[id].updateHistory.length - 1] : '';

                row.innerHTML = `
                    <td>${count++}</td>
                    <td>${data[id].datetime}</td>
                    <td>${data[id].tagNumber}</td>
                    <td>${data[id].indication}</td>
                    <td>${data[id].mtcBy}</td>
                    <td>
                        <select data-id="${id}" class="status-dropdown">
                            <option value="No Action" ${data[id].status === 'No Action' ? 'selected' : ''}>No Action</option>
                            <option value="Ongoing" ${data[id].status === 'Ongoing' ? 'selected' : ''}>Ongoing</option>
                            <option value="Close" ${data[id].status === 'Close' ? 'selected' : ''}>Close</option>
                        </select>
                    </td>
                    <td>${data[id].wr}</td>
                    <td>${data[id].pic}</td>
                    <td>${data[id].numberWorkRequest}</td>
                    <td><button data-id="${id}" class="update-button">Update</button></td>
                    <td>${lastUpdate}</td>
                    <td><button data-id="${id}" class="delete-button">Hapus</button></td>
                `;

                tableBody.appendChild(row);
            }

            // Add event listeners for update and delete buttons
            document.querySelectorAll('.update-button').forEach(button => {
                button.addEventListener('click', () => {
                    const id = button.getAttribute('data-id');
                    const status = document.querySelector(`.status-dropdown[data-id="${id}"]`).value;
                    const updatesRef = ref(database, `workRequests/${id}/updateHistory`);
                    const currentDateTime = new Date().toLocaleString();
                    const newUpdateHistory = data[id].updateHistory ? [...data[id].updateHistory, currentDateTime] : [currentDateTime];update(ref(database, `workRequests/${id}`), {
                        status,
                        updateHistory: newUpdateHistory
                    }).then(() => {
                        alert('Data berhasil diupdate!');
                    }).catch(error => {
                        console.error('Error updating data:', error);
                    });
                });
            });

            document.querySelectorAll('.delete-button').forEach(button => {
                button.addEventListener('click', () => {
                    const id = button.getAttribute('data-id');
                    const verificationCode = prompt('Masukkan kode verifikasi untuk menghapus:');
                    if (verificationCode === '1111') {
                        remove(ref(database, `workRequests/${id}`)).then(() => {
                            alert('Data berhasil dihapus!');
                        }).catch(error => {
                            console.error('Error deleting data:', error);
                        });
                    } else {
                        alert('Kode verifikasi salah.');
                    }
                });
            });
        });
    </script>
</body>
</html>